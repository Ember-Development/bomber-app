- name: Build frontend
  run: pnpm run dumb
  working-directory: apps/web
  env:
    VITE_API_URL: 'https://api.bomberadmin.net'

- name: Deploy to Server
  uses: easingthemes/ssh-deploy@main
  with:
    SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    REMOTE_HOST: ${{ secrets.WEB_HOST }}
    REMOTE_USER: ubuntu
    SOURCE: 'apps/web/dist/' # Only deploy the built output
    TARGET: ~/web-dist
    # No excludes needed - we're only sending dist/

- name: Move build to /var/www/html
  run: |
    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key
    chmod 600 ssh_key
    ssh -i ssh_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.WEB_HOST }} << 'ENDSSH'
    rsync -av --delete --exclude='.htaccess' /home/ubuntu/web-dist/ /var/www/html/
    ENDSSH
    rm -f ssh_key

name: mobile

on:
  push:
    branches:
      - main
      - ci-cd
      - fastlane
  workflow_dispatch:

jobs:
  deploy:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: apps/mobile

      - name: Install Fastlane
        run: gem install fastlane

      - name: Set up code signing
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_ID: 'emberdevco@gmail.com'
        run: |
          # Create a temporary keychain
          fastlane run create_keychain name:"github_actions_keychain" password:"$KEYCHAIN_PASSWORD" unlock:true default_keychain:true


          # Set up certificates and provisioning profiles
          fastlane run match \
            type:appstore \
            app_identifier:"com.bomberfastpitch.bomberapp" \
            username:"$APPLE_ID" \
            team_id:"56SR3FVFLU" \
            readonly:false \
            skip_git:true \
            keychain_name:"github_actions_keychain" \
            keychain_password:"$KEYCHAIN_PASSWORD"

          # Set up provisioning profiles using match
          # Since your git_url is the same as the repo, we don't need to specify it again
          fastlane run match type:appstore app_identifier:"com.bomberfastpitch.bomberapp" username:"${{ secrets.APPLE_ID }}" team_id:"56SR3FVFLU" readonly:true keychain_name:"github_actions_keychain" keychain_password:"$KEYCHAIN_PASSWORD"

      - name: Setup App Store Connect API Key
        env:
          APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
        run: |
          # Decode and save the API key
          mkdir -p $RUNNER_TEMP/private_keys
          echo -n "$APPLE_API_KEY_P8_BASE64" | base64 --decode > $RUNNER_TEMP/private_keys/AuthKey_P928568HLS.p8

      - name: Deploy to TestFlight
        env:
          APPLE_API_KEY_ID: P928568HLS
          APPLE_API_ISSUER_ID: 425b5653-6bc0-4e0d-8e8d-a3456d7828d7
        run: |
          # Create a modified Fastfile with correct path
          cat > Fastfile.modified << 'EOL'
          default_platform(:ios)
          platform :ios do
            desc "Build and upload to TestFlight"
            lane :beta do
              # Ensure proper code signing setup
              update_code_signing_settings(
                use_automatic_signing: false,
                path: "ios/bomberapp.xcodeproj",
                team_id: "56SR3FVFLU", 
                code_sign_identity: "iPhone Distribution",
                profile_name: "match AppStore com.bomberfastpitch.bomberapp"
              )
              # Build the app with explicit provisioning
              build_app(
                workspace: "ios/bomberapp.xcworkspace",
                scheme: "bomberapp",
                xcargs: "-allowProvisioningUpdates",
                export_method: "app-store",
                export_options: {
                  provisioningProfiles: {
                    "com.bomberfastpitch.bomberapp" => "match AppStore com.bomberfastpitch.bomberapp"
                  }
                }
              )
              api_key = app_store_connect_api_key(
                key_id: "P928568HLS",
                issuer_id: "425b5653-6bc0-4e0d-8e8d-a3456d7828d7",
                key_filepath: "$RUNNER_TEMP/private_keys/AuthKey_P928568HLS.p8"
              )
              upload_to_testflight(
                skip_waiting_for_build_processing: true,
                api_key: api_key
              )
            end
          end
          EOL

          # Use the modified Fastfile
          mv Fastfile.modified Fastfile

          # Run the beta lane
          fastlane ios beta

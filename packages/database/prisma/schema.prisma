// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator custom_generator {
    provider = "prisma-generator-fake-data"
    output   = "../types/fake-data.ts"
}

generator client {
    provider = "prisma-client-js"
    output   = "../generated/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DB_URI")
}

enum State {
    AL
    AK
    AZ
    AR
    CA
    CO
    CT
    DE
    FL
    GA
    HI
    ID
    IL
    IN
    IA
    KS
    KY
    LA
    ME
    MD
    MA
    MI
    MN
    MS
    MO
    MT
    NE
    NV
    NH
    NJ
    NM
    NY
    NC
    ND
    OH
    OK
    OR
    PA
    RI
    SC
    SD
    TN
    TX
    UT
    VT
    VA
    WA
    WV
    WI
    WY
}

enum AttendanceStatus {
    PENDING
    ATTENDING
    MAYBE
    DECLINED
}

enum EventType {
    TOURNAMENT
    PRACTICE
    GLOBAL
}

enum UserRole {
    ADMIN
    COACH
    REGIONAL_COACH
    PLAYER
    PARENT
    FAN
}

enum Regions {
  ACADEMY
  PACIFIC
  MOUNTAIN
  MIDWEST
  NORTHEAST
  SOUTHEAST
  TEXAS
  SOUTHWEST
}

enum MediaCategory {
  TRAINING
  PODCAST
  HIGHLIGHTS
  INTERVIEWS
  MERCH
}

enum LeadKind {
  PLAYER     // “I want to become a Bomber”
  PARENT     // “My child wants to become a Bomber”
}

enum PantsSize {
    SIZE_20
    SIZE_22
    SIZE_24
    SIZE_26
    SIZE_27
    SIZE_28
    SIZE_30
    SIZE_32
    SIZE_33
    SIZE_34
    SIZE_36
    SIZE_38
}

enum AgeGroup {
    U8
    U10
    U12
    U14
    U16
    U18
    ALUMNI
}

enum Position {
    PITCHER
    CATCHER
    FIRST_BASE
    SECOND_BASE
    THIRD_BASE
    SHORTSTOP
    LEFT_FIELD
    CENTER_FIELD
    RIGHT_FIELD
    DESIGNATED_HITTER
}

enum JerseySize {
    YXS
    YS
    YM
    YL
    YXL
    AS
    AM
    AL
    AXL
    A2XL
}

enum StirrupSize {
    ADULT
    ADULT_LONG
    XL
    XL_WIDE
}

enum ShortsSize {
    YXL
    ASM
    AMD
    ALG
    AXL
    A2XL
}

model User {
    id    String  @id @default(uuid()) @db.Uuid
    email String  @unique // constrain: all 12u and under players
    phone String? //@pattern("^\+?[1-9]\d{1,14}$") // constrain: all but player, fan, and admin
    pass  String
    fname String
    lname String

    primaryRole UserRole
    admin       Admin?
    coach       Coach?
    regCoach    RegCoach?
    player      Player?
    parent      Parent?
    fan         Fan?

    sentMessages  Message[]
    chats         UserChat[]
    events        EventAttendance[]
    notifications UserNotification[]
    refreshTokens  RefreshToken[]

    devices Device[]
    pushReceipts PushReceipt[]

    isDeleted Boolean @default(false)
}

model Player {
    id String @id @default(uuid()) @db.Uuid

    pos1      Position
    pos2      Position
    jerseyNum String //@pattern("^[0-9]{1,2}$")
    gradYear  String //@pattern("^20[2-9][0-9]$")

    jerseySize        JerseySize
    pantSize          PantsSize
    stirrupSize       StirrupSize
    shortSize         ShortsSize
    practiceShortSize ShortsSize

    ageGroup AgeGroup

    user   User?   @relation(fields: [userID], references: [id]) // constrain: all players > 12u have user login
    userID String? @unique @db.Uuid

    team   Team?   @relation(fields: [teamID], references: [id])
    teamID String? @db.Uuid

    //8-14u
    parents Parent[]

    //14u only
    isTrusted Boolean?

    //14u to alumn
    address   Address? @relation(fields: [addressID], references: [id])
    addressID String?  @db.Uuid

    

    college String?
    commitId String? @db.Uuid
    commit    Commit?     @relation("PlayerCommit", fields: [commitId], references: [id])
    convertedFromLead  PortalLead? @relation("PortalLeadConvertedPlayer")
}

model Commit {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  state        String
  city         String
  imageUrl     String
  committedDate DateTime

  players      Player[] @relation("PlayerCommit")
}

model Admin {
    id     String @id @default(uuid()) @db.Uuid
    user   User   @relation(fields: [userID], references: [id])
    userID String @unique @db.Uuid
}

model Fan {
    id     String @id @default(uuid()) @db.Uuid
    user   User   @relation(fields: [userID], references: [id])
    userID String @unique @db.Uuid
}

model Coach {
    id String @id @default(uuid()) @db.Uuid

    user   User   @relation(fields: [userID], references: [id])
    userID String @unique @db.Uuid

    address   Address? @relation(fields: [addressID], references: [id])
    addressID String?  @db.Uuid

    headTeams Team[]
    teams     Team[] @relation("CoachTeams")
}

model RegCoach {
    id     String @id @default(uuid()) @db.Uuid
    user   User   @relation(fields: [userID], references: [id])
    userID String @unique @db.Uuid


    region Regions @unique //one regCoach per region, allows queries for team by regional coach
}

model Team {
    id String @id @default(uuid()) @db.Uuid

    name     String
    teamCode String?  @unique
    ageGroup AgeGroup
    region   Regions
    state    State    @default(TX)

    trophyCase Trophy[]

    players Player[]

    coaches     Coach[] @relation("CoachTeams")
    headCoach   Coach?  @relation(fields: [headCoachID], references: [id])
    headCoachID String? @db.Uuid
}

model Trophy {
    id String @id @default(uuid()) @db.Uuid

    title    String
    imageURL String

    team   Team?  @relation(fields: [teamID], references: [id])
    teamID String @db.Uuid
}

model Parent {
    id String @id @default(uuid()) @db.Uuid

    children Player[]

    address   Address @relation(fields: [addressID], references: [id])
    addressID String  @db.Uuid

    user   User   @relation(fields: [userID], references: [id])
    userID String @unique @db.Uuid
}

model Address {
    id String @id @default(uuid()) @db.Uuid

    //TODO: see if we can get location enums, if not no worries
    state    String
    city     String
    zip      String
    address1 String
    address2 String?

    players Player[]
    parents Parent[]
    coaches Coach[]
}

model Chat {
    id String @id @default(uuid()) @db.Uuid

    title         String
    createdAt     DateTime
    lastMessageAt DateTime @default(now())

    users    UserChat[]
    messages Message[]

    @@index([lastMessageAt, id])
}

model UserChat {
    user   User   @relation(fields: [userID], references: [id])
    userID String @db.Uuid
    chat   Chat   @relation(fields: [chatID], references: [id])
    chatID String @db.Uuid

    joinedAt DateTime

    @@id([userID, chatID])
}

model Message {
    id String @id @default(uuid()) @db.Uuid

    text         String
    createdAt    DateTime
    retryCount   Int      @default(0)
    failedToSend Boolean  @default(false)

    sender User   @relation(fields: [userID], references: [id])
    userID String @db.Uuid

    chat   Chat   @relation(fields: [chatID], references: [id])
    chatID String @db.Uuid
}

model Device {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  platform   String   // 'ios' | 'android'
  token      String   @unique
  appVersion String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  receipts PushReceipt[]
}

model Notification {
    id String @id @default(uuid()) @db.Uuid

    users UserNotification[]

    title     String
    body      String
    createdAt DateTime

    imageUrl    String?
    deepLink    String?
    platform    String?   // 'both' | 'ios' | 'android'
    status      String?   // 'draft' | 'queued' | 'sent' | 'failed'
    scheduledAt DateTime?
    sentAt      DateTime?
    data        Json?
    audience    Json?

    pushReceipts PushReceipt[]
}

model PushReceipt {
  id             String   @id @default(uuid()) @db.Uuid
  notificationId String   @db.Uuid
  userId         String   @db.Uuid
  deviceId       String   @db.Uuid

  deliveredAt   DateTime?
  openedAt      DateTime?
  failureReason String?

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       Device       @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([deviceId, notificationId], name: "deviceId_notificationId")
  @@index([userId])
  @@index([notificationId])
}

model UserNotification {
    user           User         @relation(fields: [userID], references: [id])
    userID         String       @db.Uuid
    notification   Notification @relation(fields: [notificationID], references: [id])
    notificationID String       @db.Uuid

    isRead Boolean @default(false)

    @@id([userID, notificationID])
}

model Event {
    id String @id @default(uuid()) @db.Uuid

    tournament   Tournament? @relation(fields: [tournamentID], references: [id])
    tournamentID String?     @db.Uuid

    eventType EventType

    start DateTime
    end   DateTime

    title    String
    body     String?
    location String?

    attendees EventAttendance[] // constraint: DO NOT fill this for global events
}

model EventAttendance {
    id String @id @default(uuid()) @db.Uuid

    user    User   @relation(fields: [userID], references: [id])
    userID  String @db.Uuid
    event   Event  @relation(fields: [eventID], references: [id])
    eventID String @db.Uuid

    status AttendanceStatus @default(PENDING)

    @@unique([userID, eventID])
}

model Tournament {
    id String @id @default(uuid()) @db.Uuid

    start DateTime
    end   DateTime

    title    String
    body     String
    location String

    imageURL String

    events Event[]
}

model Sponsor {
    id      String @id @default(uuid()) @db.Uuid
    title   String
    url     String
    logoUrl String // store path or full URL

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Banner {
    id        String   @id @default(uuid()) @db.Uuid
    imageUrl  String
    // duration in hours, e.g. 6, 12, 24
    duration  Int
    expiresAt DateTime @default(now())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Media {
  id        String   @id @default(uuid()) @db.Uuid
  title     String
  videoUrl  String
  category   MediaCategory
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Article {
    id       String  @id @default(uuid()) @db.Uuid
    title    String
    body     String
    link     String? // optional external link
    imageUrl String? // optional header image

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model PortalLead {
  id        String   @id @default(uuid()) @db.Uuid
  kind      LeadKind

  playerFirstName String
  playerLastName  String
  ageGroup        AgeGroup
  pos1            Position?
  pos2            Position?
  gradYear        String?

  parentFirstName String?
  parentLastName  String?
  parentEmail     String?
  parentPhone     String?

  email  String?
  phone  String?

  createdAt DateTime @default(now())

  // link to a created Player later
  convertedPlayerId String?  @unique @db.Uuid
  convertedPlayer   Player?  @relation("PortalLeadConvertedPlayer", fields: [convertedPlayerId], references: [id])
}

model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  hashedToken String
  createdAt   DateTime @default(now())
  revokedAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

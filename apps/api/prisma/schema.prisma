// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URI")
}

enum UserRole {
    ADMIN
    COACH
    REGIONAL_COACH
    PLAYER
    FAN
}

enum Regions {
 NORTHWEST
 SOUTHWEST
 SOUTH
 SOUTHEAST
 NORTHEAST
 MIDWEST
}

enum AgeGroup {
    U8
    U10
    U12
    U14
    U16
    U18
    ALUMNI
}

enum Position {
    PITCHER
    CATCHER
    FIRST_BASE
    SECOND_BASE
    THIRD_BASE
    SHORTSTOP
    LEFT_FIELD
    CENTER_FIELD
    RIGHT_FIELD
    DESIGNATED_HITTER
}

enum UniformSize {
    YS
    YM
    YL
    AS
    AM
    AL
    AXL
    A2XL
}

enum StateCodes {
        AK
        AL
        AZ
        AR
        CA
        CO
        CT
        DE
        FL
        GA
        HI
        ID
        IL
        IN
        IA
        KS
        KY
        LA
        ME
        MD
        MA
        MI
        MN
        MS
        MO
        MT
        NE
        NV
        NH
        NJ
        NM
        NY
        NC
        ND
        OH
        OK
        OR
        PA
        RI
        SC
        SD
        TN
        TX
        UT
        VT
        VA
        WA
        WV
        WI
        WY
}

model User {
  id      Int      @id @default(autoincrement())
  email   String?  @unique //TODO: figure out how to make this mandatory for all except <=12U
  phone   String   @pattern("^\+?[1-9]\d{1,14}$") // E.164 format
  pass    String
  fname   String
  lname   String

  //TODO: for all the following add appropriate relations
  primaryRole enum //TODO: primary_role enum
  admin   Admin?
  coach   Coach?
  regCoach RegCoach?
  player  Player?
  fan     Fan?
}

model Admin {
    id  Int @id @default(autoincrement())
    user Users @relation(fields: [userID], references: [id])
    userID Int @unique
}

model Fan {
    id  Int @id @default(autoincrement())
    user Users @relation(fields: [userID], references: [id])
    userID Int @unique
}

model Coach {
    id  Int @id @default(autoincrement())
    
    user Users @relation(fields: [userID], references: [id])
    userID Int @unique

    phone String  @pattern("^\+?[1-9]\d{1,14}$") // E.164 format
    teams Team[]
}

model RegCoach {
    id  Int  @id @default(autoincrement())
    user Users @relation(fields: [userID], references: [id])
    userID Int @unique

    teams Team[] //TODO: enforce region matched teams
    region Region
    phone String  @pattern("^\+?[1-9]\d{1,14}$") // E.164 format
}

model Team {
    id  Int @id @default(autoincrement())
    
    name String 
    ageGroup AgeGroup
    region Region

    headCoach Coach @relation(fields: [headCoachID], references: [id])
    headCoachID Int

    trophyCase Trophy[]
}

model Trophy {
    id  @id @default(@autoincrement())
    
    title String
    imageURL String

    team Team? @relation(fields: [teamID], references: [id])
    teamID Int
}

model Player {
    id  @id @default(@autoincrement())
    
    team @relation(fields: [teamID], references: [id])
    teamID Int

    pos1 Position
    pos2 Position
    jerseyNum @pattern("^[0-9]{1,2}$")
    gradYear @pattern("^20[2-9][0-9]$") 

    jerseySize UniformSize
    pantSize UniformSize
    stirrupSize UniformSize
    shortSize UniformSize 
    practiceShortSize UniformSize

    ageGroup AgeGroup

    //8-14u
    parents Parent[]

    //14u only
    isTrusted Boolean? 

    //14u to alumn
    address Address? @relation(fields: [addressID], references:id])
    addressID Int?
    college String? //TODO: think about populating this with enums perhaps //NOTE: is truly optional

    // constraints for each age group
    @@schema("""
        ALTER TABLE "Player" ADD CONSTRAINT "parents_required_14_under"
        CHECK (
            (ageGroup IN('U8', 'U12', 'U14') AND EXISTS (
                SELECT 1 FROM "_ParentToPlayer" // TODO: touch this up and be careful about join tables
                WHERE "B" = "Player"."id"
                LIMIT 1
            ))
            OR
            (ageGroup NOT IN ('U8', 'U12', 'U14'))
        );

        ALTER TABLE "Player" ADD CONSTRAINT "is_trusted_14u"
        CHECK (
            (ageGroup = 'U14' AND "isTrusted" IS NOT NULL)
            OR
            (ageGroup != 'U14')
        );

        ALTER TABLE "Player" ADD CONSTRAINT "address_14_over"
        CHECK (
            (ageGroup IN ('U14', 'U16', 'U18') AND "addressID" IS NOT NULL)
            OR
            (ageGroup NOT IN  ('U14','U16', 'U18'))
        );
    """)
}

model Parent {
    id  @id @default(@autoincrement())

    children Player[]

    phone String  @pattern("^\+?[1-9]\d{1,14}$") // E.164 format
}

model Address {
    id  @id @default(@autoincrement())

    //TODO: see if we can get location enums, if not no worries
    state enum
    city enum
    zip string // TODO: constrain string?
    address_1 string
    address_2 string
}

//NOTE: The following is only test data
model Post {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String   @db.VarChar(255)
  content   String?
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  Int
}

model Profile {
  id     Int     @id @default(autoincrement())
  bio    String?
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int     @unique
}

model User {
  id      Int      @id @default(autoincrement())
  email   String   @unique
  name    String?
  posts   Post[]
  profile Profile?
}

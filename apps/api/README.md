## Bomber API

This document describes the Express API living in `apps/api`. The server powers Bomber user management, teams, chat, events, content, notifications, and public web forms. It runs on top of Prisma (PostgreSQL), exposes REST endpoints under `/api`, and hosts a Socket.IO gateway for chat.

---

## Runtime & Base URLs

- **Base URL (local dev):** `http://localhost:3000`
- **Health:** `GET /` → `"Ready 4 Biznes!"`
- **Primary mount:** every route in `api.ts` is hanging off `/api/...`.
- **Environment:** copy `.example.env` to `.env` and fill in:
  - `PORT`, `CORS_ORIGINS` (comma-delimited allow list),
  - `JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET`, optional `ACCESS_EXPIRES_IN`, `REFRESH_EXPIRES_IN`,
  - Push/notification credentials (`PUSH_ENABLED`, APNs + FCM keys),
  - Email/password-reset credentials (`RESEND_API_KEY`, `RESET_*`).

Express middleware stack: CORS (dynamic allow list), global `OPTIONS` handler, Helmet, JSON body parser, Morgan logging, then routers. Errors are funneled to a single handler that returns `{ "error": string }` and status 4xx/5xx.

---

## Authentication & Authorization

### Token lifecycle

| Step | Endpoint | Notes |
| --- | --- | --- |
| Sign up | `POST /api/auth/signup` | Validates profile + role-specific payload, creates user, returns `{ access, refresh, user }`. |
| Login | `POST /api/auth/login` | Requires `email`, `password`; returns `{ access, refresh, user }`. |
| Refresh | `POST /api/auth/refresh` | Pass `{ token: <refresh> }`; rotates stored token & returns new pair. |
| Logout | `POST /api/auth/logout` | Revokes every active refresh token for the caller (`auth` required). |
| Current user | `GET /api/auth/me` | Returns hydrated profile assembled via Prisma includes. |
| Forgot/reset password | `POST /api/auth/forgot-password` & `POST /api/auth/reset-password` | Works with Resend-based emails; reset requires `{ email, token, password }`. |

- Send the `access` token in `Authorization: Bearer <jwt>`.
- Access tokens default to `15m`, refresh tokens to `7d` (override via env).
- `auth` middleware fetches user roles/actions; failing checks yields `401` or `403`.
- `authorize(Action)` middleware (see `auth/permissions.ts`) enforces fine-grained permissions.

### Roles → notable actions

| Role | Key actions automatically granted |
| --- | --- |
| `ADMIN` | all coach/player CRUD, trophies, group management, CMS operations, user deletion. |
| `COACH` | edit/view own teams, player maintenance, messaging group creation, trophies. |
| `REGIONAL_COACH` | coach/player oversight within assigned region, group creation, trophies. |
| `PLAYER`, `PARENT` | `view-my-info`, `edit-my-info`, `view-my-team`; limited player edits. |
| `FAN` | read-only profile + version info. |

⚠️ A handful of endpoints currently skip `auth`/`authorize` (documented per-route below). Treat them as public until middleware is added.

---

## API Conventions

- **Content type:** JSON (`application/json`). Use UTF-8 strings, snake_case is not enforced.
- **IDs:** UUIDv4 strings generated by Prisma unless otherwise noted (e.g., `teamCode` short strings).
- **Timestamps:** ISO8601 in UTC (`createdAt`, `updatedAt`, `sentAt`, etc.).
- **Pagination:** cursor-based for lists such as messages, players, and groups (`cursor` query param plus `limit`). When pagination is supported the response includes `nextCursor`.
- **Errors:** structured as `{ error: string }` or `{ message: string }`. Validation helpers typically reply with 400 + `{ errors: string[] }`.
- **Authorization actions:** documented as `Bearer (action-name)` below. All other authenticated endpoints simply require a valid JWT.

---

## Realtime & Notifications

- **Socket.IO (`websockets/websocket.ts`):**
  - Connect via the same origin, then emit `joinChat` with a chat ID to begin receiving `NewMessage`.
  - `sendMessage` payload: `{ text, chatId, userId }`. The server writes through `messageService` then emits `NewMessage`.
  - `retryMessage` payload: `{ messageId }` triggers another delivery attempt.
  - Redis pub/sub (env `REDIS_HOST`/`REDIS_PORT`) backs the adapter for scale-out.
  - ⚠️ WebSocket payloads are trusted; pass authenticated `userId`.

- **Push notifications:**
  - Register devices with `POST /api/devices/register` (see table below).
  - Notification creation & delivery uses APNs/FCM via `lib/push.ts`; `sendNotificationRecord` fans out per-device and maintains unread counts/badges in `userNotification` + `pushReceipt`.

---

## Endpoint Reference

Legend:
- **Auth column values:** `Public`, `Bearer`, or `Bearer (permission)`.
- Query params and body expectations follow each table.

### Auth (`/api/auth`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| POST | `/api/auth/signup` | Public | Create a user; body validated per-role (players need `pos1`, `jerseyNum`, `gradYear`; coaches/parents optionally include address hooks). |
| POST | `/api/auth/login` | Public | Issue `{ access, refresh, user }`. |
| POST | `/api/auth/refresh` | Public | Rotate refresh token, return new pair. |
| POST | `/api/auth/logout` | Bearer | Revoke all refresh tokens for caller. |
| GET | `/api/auth/me` | Bearer | Return hydrated profile (user + nested relations). |
| POST | `/api/auth/forgot-password` | Public | Trigger password-reset email (always 200). |
| POST | `/api/auth/reset-password` | Public | Verify reset token and set a new password. |

Payload highlights:
- `signup`: `{ email, password, fname, lname, role, phone, player?, coach?, parent? }`.
- `login`: `{ email, password }`.
- `refresh`: `{ token }`.
- `reset-password`: `{ email, token, password }` (password ≥ 8 chars).

### Users (`/api/users`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/users` | Bearer | List all users (includes nested roles/teams). |
| GET | `/api/users/web` | Public | Same payload as `/api/users`; exposed for marketing site. |
| POST | `/api/users` | Bearer | Create a raw user record; body matches Prisma `UserCreateInput`. |
| GET | `/api/users/group/:chatId` | Bearer | Members of a chat (via `userService.getUsersByChatId`). |
| GET | `/api/users/:id/events` | Bearer | Events the user can attend (includes global events). |
| GET | `/api/users/:id/chats` | Bearer | Chats the user belongs to, ordered by recent message. |
| PUT | `/api/users/:id` | Bearer (edit-my-info) | Update scalar profile fields plus nested player/coach/parent records; handles address upsert + commit connection. |
| DELETE | `/api/users/me` | Bearer | Self-service soft delete. |
| DELETE | `/api/users/:id` | Bearer (delete-user) | Admin soft delete. |
| POST | `/api/users/address` | Public | Create an address record `{ address1, city, state, zip, address2? }`. |
| POST | `/api/users/:userId/ensure-role` | Bearer (edit-coach) | Ensure a `COACH`/`ADMIN`/`FAN` record exists for target user. |
| POST | `/api/users/:id/change-password` | Bearer (edit-my-info) | `{ currentPassword, newPassword }`; admins can change others’ passwords. |
| PATCH | `/api/users/:userId/reg-coach` | Bearer (edit-coach) | Assign / move a regional coach (`regCoachService.upsertRegionWithTakeover`). |
| DELETE | `/api/users/:userId/reg-coach` | Bearer (edit-coach) | Demote regional coach (optionally `?newRole=FAN`). |
| GET | `/api/users/latest-version` | Public | Returns mobile app metadata from `utils/versionManager`. |

### Teams (`/api/teams`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/teams` | Public | Full team list with players, coaches, trophies (sorted by age group). |
| GET | `/api/teams/:id` | Public | Team by ID (includes players/coaches/trophies). |
| GET | `/api/teams/code/:code` | Public ⚠️ | Lookup by `teamCode`. **Note:** defined after `/:id`, so Express currently never reaches it unless route order is adjusted. |
| GET | `/api/teams/my-team` | Bearer (view-my-team) | Teams for which the caller is head coach or assistant. |
| PATCH | `/api/teams/my-team/:id` | Bearer (edit-my-team) | Update limited fields for caller’s team. |
| DELETE | `/api/teams/my-team/:id` | Bearer (delete-my-team) | Remove caller-managed team. |
| POST | `/api/teams` | Bearer | Create team `{ name, ageGroup, region, state, headCoachUserID? }`; auto-generates unique `teamCode`. |
| PUT | `/api/teams/:id` | Bearer | Update team meta (same shape as create). |
| DELETE | `/api/teams/:id` | Bearer | Hard delete team. |
| POST | `/api/teams/:teamId/coaches` | Public ⚠️ | Body `{ userID }`; ensures coach record then connects. Should be locked down. |
| POST | `/api/teams/:teamId/players` | Public ⚠️ | Body `{ userID }`; ensures player record then connects. |
| POST | `/api/teams/:teamId/trophies` | Bearer (create-trophy) | `{ title, imageURL }`; capped at 10 trophies/team. |
| PUT | `/api/teams/:teamId/trophies/:trophyId` | Bearer (edit-trophy) | Update trophy metadata. |
| DELETE | `/api/teams/:teamId/trophies/:trophyId` | Bearer (remove-trophy) | Delete trophy. |

### Players (`/api/players`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/players` | Bearer | List every player (with user/team/parents/address). |
| GET | `/api/players/alumni` | Public | Paginated alumni feed (`cursor`, `limit`). |
| GET | `/api/players/unassigned` | Bearer | Paginated list of players without a team. Query: `cursor`, `limit`, `search`, `ageGroup`. |
| GET | `/api/players/:id` | Bearer | Fetch single player (includes commit summary). |
| POST | `/api/players` | Bearer | Create player; payload extends Prisma `PlayerCreateInput` with optional inline address fields. Validation enforces: self-managed players (14U+) need address, parent-managed requires ≥1 parent. |
| POST | `/api/players/:id/commit` | Bearer | Attach a commit (college) record `{ name, state, city, imageUrl?, committedDate }`. |
| POST | `/api/players/add-to-team` | Public ⚠️ | `{ playerId, teamCode }` connects player to team by join code. |
| PUT | `/api/players/:id` | Bearer (edit-player) | Update player bio, jersey sizes, commit linkage, nested user contact, and address (upsert). |
| DELETE | `/api/players/:id/team` | Bearer (edit-player) | Remove team assignment. |
| POST | `/api/players/:id/parents` | Bearer (edit-player) | Body `{ parentId }`; resolves by parent ID or user ID (creates parent if needed) and links. |
| DELETE | `/api/players/:id/parents/:parentId` | Bearer (edit-player) | Accepts parent ID or parent’s user ID (also allowed via body). |
| DELETE | `/api/players/:id` | Bearer (remove-player) | Delete player (authorized via team/region membership). |

### Parents (`/api/parents`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/parents/:id` | Bearer | Return parent, children, address. |
| POST | `/api/parents/ensure` | Bearer | Upsert parent row for the caller; copies address from existing coach/player address when possible. |
| POST | `/api/parents/:id/children` | Bearer (edit-player) | Body `{ playerId }`; connect player to parent. |
| DELETE | `/api/parents/:id/children/:playerId` | Bearer (edit-player) | Disconnect child. |

### Coaches & Regional Coaches

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/coaches` | Public | List all coaches (with user + team/address). |
| GET | `/api/coaches/:id` | Bearer | Single coach. |
| PUT | `/api/coaches/:id` | Bearer (edit-coach) | Update coach profile + nested user/address fields. |
| POST | `/api/coaches/remove-coach-from-team` | Bearer (edit-coach) | Body `{ coachId, teamId }`; removes coach from team and clears `headCoachID` if needed. |
| DELETE | `/api/coaches/:id` | Bearer (remove-coach) | Delete coach record. |
| GET | `/api/regCoaches` | Bearer (edit-coach) | List regional coaches (with user). |
| POST | `/api/regCoaches` | Bearer (edit-coach) | Body `{ userId, region }`; admin-only in controller. Handles unique-region constraint errors. |
| DELETE | `/api/regCoaches/:userId` | Bearer (edit-coach) | Remove user’s regional coach slot. |

### Groups & Messaging

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/groups` | Bearer | Paginated chats. Query: `take` (default 10), `cursor` JSON string `{"lastMessageAt": "...", "id": "..."}`. |
| POST | `/api/groups` | Bearer (create-team-group) | `{ title, userIds }`; validates access based on caller role/team/region, auto-includes caller & parents for under-14 players. |
| POST | `/api/groups/:groupId/users` | Bearer (add-user-to-group) | Add users who pass access rules. |
| POST | `/api/groups/admin/backfill-last-message-at` | Bearer | Iterates chats and sets `lastMessageAt` to most recent message. No extra guard—treat as admin-only maintenance. |
| GET | `/api/messages/:groupId` | Bearer | Messages for a chat. Query: `cursor`, `limit` (default 20). Results ordered newest-first. |
| GET | `/api/messages` | Bearer | Fetch every message (debug/admin). |
| POST | `/api/messages` | Bearer | Send message `{ text, groupId, userId }` (server does not cross-check `userId` vs token). |
| POST | `/api/messages/:messageId/retry` | Bearer | Retry failed message; enforces ≤3 retries. |

### Events (`/api/events`)

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| GET | `/api/events` | Public | Full event feed (includes tournaments & attendee info). |
| GET | `/api/events/:id` | Bearer | Specific event. |
| POST | `/api/events` | Bearer | Body `{ event: NewEvent, attendees?: NewEventAttendance[], tournamentID?: string }`. Global events (`eventType: GLOBAL`) cannot include attendees. |
| PUT | `/api/events/:id` | Bearer | Update event fields (no extra guard). |
| DELETE | `/api/events/:id` | Bearer | Deletes event after verifying actor. |
| GET | `/api/events/:id/attendees` | Bearer | List attendees (status + user info). |
| POST | `/api/events/:id/attendees` | Bearer | Body `{ userIds: string[], status?: AttendanceStatus }`; defaults to `PENDING`. |
| DELETE | `/api/events/:id/attendees/:userId` | Bearer | Remove attendee. |
| POST | `/api/events/:id/rsvp` | Bearer | Self-service RSVP; body `{ status: "ATTENDING"|"MAYBE"|"DECLINED" }`. Rejects global events. |
| DELETE | `/api/events/:id/rsvp` | Bearer | Remove caller’s RSVP. |

### Notifications & Devices

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| POST | `/api/devices/register` | Public ⚠️ | `{ userId, platform: "ios"|"android", token (≥10 chars), appVersion? }`; upserts device tokens. |
| POST | `/api/notifications` | Public ⚠️ | Create notification draft/queued record. Validates via `validateCreateNotification`. |
| POST | `/api/notifications/:id/send` | Public ⚠️ | Immediately queue & dispatch a notification. |
| PUT | `/api/notifications/:id` | Public ⚠️ | Update draft content (`title`, `body`, `imageUrl`, `deepLink`, `platform`, `audience`, `data`). |
| DELETE | `/api/notifications/:id` | Public ⚠️ | Delete notification record. |
| GET | `/api/notifications/drafts` | Public ⚠️ | List drafts ordered by `createdAt`. |
| GET | `/api/notifications/feed` | Bearer | Personalized feed; `?unreadOnly=false` to show historical sent items. Without auth, returns public sent feed. |
| POST | `/api/notifications/receipt/open` | Bearer | Body `{ notificationId }`; marks push receipts opened + `userNotification.isRead = true`. |
| POST | `/api/notifications/readAll` | Bearer | Body `{ before?: ISODateString }`; marks unread feed items as read up to timestamp. |

Payload tips:
- `audience` must include at least one of `{ all, roles, regions, teamIds, userIds }`.
- Optional `scheduledAt` (ISO string) queues notification with `status: "queued"`; `null` keeps it a draft.
- `data` must be an object of string values (used for push extras).

### Content & Marketing

| Domain | Endpoints | Auth | Notes |
| --- | --- | --- | --- |
| Articles (`/api/articles`) | GET all, GET by ID (public); POST/PUT/DELETE (Bearer) | Controllers accept `{ title, body, link?, imageUrl? }`. Consider pairing with CMS actions (permissions exist: `cms:*`). |
| Media (`/api/medias`) | GET all/by ID (public), POST/PUT/DELETE (Bearer) | `category` validated against Prisma `MediaCategory` enum (defaults to `HIGHLIGHTS`). |
| Banners (`/api/banners`) | GET/POST/PUT/DELETE | All require Bearer. `create` needs `{ imageUrl, link?, duration(seconds), expiresAt }`. |
| Sponsors (`/api/sponsors`) | GET all (public), GET by ID (Bearer), POST/PUT/DELETE (Bearer) | Body `{ title, url, logoUrl }`. |
| Commits (`/api/commits`) | GET all (public), GET by ID (Bearer), POST (public), PATCH/DELETE (Bearer) | `POST` requires `{ name, state, city, committedDate, imageUrl? }`. Returned commits include attached players. |
| Analytics (`/api/analytics`) | GET (Bearer) | Summaries: `{ totalPlayers, totalNotificationsSent, totalTeams, totalUsers }`. |
| Schools (`/api/schools`) | GET (Public) | Returns cached contents of `data/schools.json` (auto-refresh on file change). |

### Portals & Forms

| Method | Endpoint | Auth | Description |
| --- | --- | --- | --- |
| POST | `/api/portal/leads` | Bearer | `{ kind: "PLAYER"|"PARENT", playerFirstName, playerLastName, ageGroup, pos1?, pos2?, gradYear?, email?, phone?, parent* }`. Players 14U and under must be submitted via `kind: "PARENT"`. |
| GET | `/api/portal/leads` | Bearer | Returns latest leads (descending). |
| POST | `/api/recruitment` | Public | Recruitment form. Requires `{ name, email, phone, city, state, role, type }` + type-specific fields. Sends styled email to staff plus confirmation to applicant. |
| POST | `/api/contact` | Public | Contact form. Body `{ name, email, subject, message, phone? }`; emails staff + auto-responds. |

---

## Web Assets & Files

- `uploads/banners/` stores banner images (names include UUID + timestamp). The API currently expects `imageUrl` fields pointing at accessible storage.
- Static lookup data (schools) sits under `data/schools.json` and is cached in-memory; edits require server restart or file timestamp bump.

---

## Known Gaps & Considerations

1. **Unauthenticated mutating endpoints:** `POST /api/teams/:teamId/(coaches|players)`, `POST /api/players/add-to-team`, notification CRUD, `POST /api/devices/register`, and `POST /api/commits` lack JWT protection. Add `auth` (and appropriate `authorize`) before exposing publicly.
2. **Route shadowing:** `GET /api/teams/code/:code` is unreachable because `/api/teams/:id` is registered first. Swap order or use query param to enable lookup by team code.
3. **Message spoofing:** Both REST (`POST /api/messages`) and Socket.IO accept `userId` from the body/event without comparing against `req.user`; malicious clients could impersonate other senders.
4. **Admin utilities:** `/api/groups/admin/backfill-last-message-at` and `/api/messages` are only gated by `auth`. Restrict to admin roles via `authorize`.
5. **Device registration flood:** Rate limiting / token binding is not enforced; consider hashing device tokens server-side before logging.

---

## Testing Checklist

- **Happy path:** sign up, login, fetch `/api/auth/me`, hit a protected route (`/api/users/me`), refresh token, logout.
- **Role-gated flows:** verify `authorize` rules by simulating COACH vs ADMIN for player edit, trophy creation, group creation, etc.
- **Pagination:** fetch `GET /api/messages/:groupId?limit=20` twice using returned cursor; repeat for `/api/players/unassigned`.
- **Forms:** submit `/api/contact` & `/api/recruitment` with required fields to ensure Resend/email credentials are wired.
- **Push:** register device, create notification with `audience.userIds`, call `/api/notifications/:id/send`, check `pushReceipt` and feed endpoints.
- **WebSockets:** connect Socket.IO client, `joinChat`, send `sendMessage`, ensure broadcast + `chat.lastMessageAt` update.

Use this reference as the source of truth when integrating mobile/web clients or when extending the API surface.